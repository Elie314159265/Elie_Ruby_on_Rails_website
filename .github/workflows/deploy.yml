# ========================================
# .github/workflows/deploy.yml - CI/CDãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# ========================================
# 
# ã€ä¸»ãªå¤‰æ›´ç‚¹ã€‘
# 1. âœ… SSHé–¢é€£ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’ã™ã¹ã¦å‰Šé™¤
# 2. âœ… Systems ManagerçµŒç”±ã§ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã«å¤‰æ›´
# 3. âœ… S3ä¸€æ™‚ä¿å­˜æ–¹å¼ã§Dockerã‚¤ãƒ¡ãƒ¼ã‚¸è»¢é€ï¼ˆåŠ¹ç‡åŒ–ï¼‰
# 4. âœ… terraform planã§ssh_public_keyå¤‰æ•°å‰Šé™¤
# 5. âœ… GitHub SecretsãŒ5å€‹â†’3å€‹ã«å‰Šæ¸›
# 
# ã€å¿…è¦ãªGitHub Secretsï¼ˆ3å€‹ã®ã¿ï¼‰ã€‘
# - AWS_ACCESS_KEY_ID
# - AWS_SECRET_ACCESS_KEY
# - RAILS_MASTER_KEY
# 
# âœ… å‰Šé™¤ã•ã‚ŒãŸSecrets:
# - SSH_PUBLIC_KEYï¼ˆä¸è¦ï¼‰
# - SSH_PRIVATE_KEYï¼ˆä¸è¦ï¼‰
# 
# ========================================

name: Deploy to AWS

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  AWS_REGION: ap-northeast-1
  TERRAFORM_VERSION: 1.7.0

jobs:
  # Terraform Infrastructureç®¡ç†
  terraform:
    name: Terraform Apply
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: terraform
    
    outputs:
      ec2_public_ip: ${{ steps.terraform_output.outputs.ec2_public_ip }}
      ec2_instance_id: ${{ steps.terraform_output.outputs.ec2_instance_id }}  # âœ… è¿½åŠ 
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false
      
      - name: Terraform Format Check
        run: terraform fmt -check -recursive
        continue-on-error: true
      
      - name: Terraform Init
        run: terraform init
      
      - name: Terraform Validate
        run: terraform validate
      
      # âœ… å¤‰æ›´: ssh_public_keyå¤‰æ•°ã‚’å‰Šé™¤
      # æ—§ã‚³ãƒ¼ãƒ‰:
      # terraform plan \
      #   -var="ssh_public_key=${{ secrets.SSH_PUBLIC_KEY }}" \
      #   -var="rails_master_key=${{ secrets.RAILS_MASTER_KEY }}" \
      #   -out=tfplan
      
      - name: Terraform Plan
        run: |
          terraform plan \
            -var="rails_master_key=${{ secrets.RAILS_MASTER_KEY }}" \
            -out=tfplan
      
      - name: Terraform Apply
        if: github.ref == 'refs/heads/main'
        run: terraform apply -auto-approve tfplan
      
      - name: Get Terraform Outputs
        id: terraform_output
        run: |
          echo "ec2_public_ip=$(terraform output -raw ec2_public_ip)" >> $GITHUB_OUTPUT
          echo "ec2_instance_id=$(terraform output -raw ec2_instance_id)" >> $GITHUB_OUTPUT  # âœ… è¿½åŠ 

  # âœ… å¤§å¹…å¤‰æ›´: Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰ã¨ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆSystems ManagerçµŒç”±ï¼‰
  # æ—§æ–¹å¼: SSH + SCPã§ã‚¤ãƒ¡ãƒ¼ã‚¸è»¢é€
  # æ–°æ–¹å¼: S3ä¸€æ™‚ä¿å­˜ + Systems Managerã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ
  deploy:
    name: Build and Deploy Application
    runs-on: ubuntu-latest
    needs: terraform
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build Docker Image
        run: |
          docker build -t rails-portfolio:latest .
          docker save rails-portfolio:latest | gzip > rails-portfolio.tar.gz
      
      # âœ… æ–°è¦è¿½åŠ : EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®æº–å‚™å®Œäº†ã‚’å¾…æ©Ÿ
      - name: Wait for EC2 Instance to be ready
        run: |
          echo "Waiting for EC2 instance to be ready..."
          aws ec2 wait instance-status-ok --instance-ids ${{ needs.terraform.outputs.ec2_instance_id }}
          echo "EC2 instance is ready!"
      
      # âœ… æ–°è¦è¿½åŠ : S3ä¸€æ™‚ãƒã‚±ãƒƒãƒˆã«Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      # SSH/SCPã§ã¯ãªãS3çµŒç”±ã§è»¢é€ï¼ˆã‚ˆã‚ŠåŠ¹ç‡çš„ï¼‰
      - name: Upload Docker Image to S3 (temporary)
        run: |
          BUCKET_NAME="rails-portfolio-deploy-temp-$(date +%s)"
          aws s3 mb s3://$BUCKET_NAME
          aws s3 cp rails-portfolio.tar.gz s3://$BUCKET_NAME/
          echo "DEPLOY_BUCKET=$BUCKET_NAME" >> $GITHUB_ENV
      
      # âœ… å¤§å¹…å¤‰æ›´: Systems ManagerçµŒç”±ã§ãƒ‡ãƒ—ãƒ­ã‚¤ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ
      # æ—§æ–¹å¼:
      # - Configure SSH
      # - Transfer Docker Image to EC2 (SCP)
      # - Deploy Application on EC2 (SSH)
      # 
      # æ–°æ–¹å¼:
      # - Systems Manager send-command ã§ã‚·ã‚§ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ
      # - SSHéµä¸è¦ã€IAMæ¨©é™ã§å®‰å…¨ã«å®Ÿè¡Œ
      - name: Deploy via Systems Manager
        run: |
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids ${{ needs.terraform.outputs.ec2_instance_id }} \
            --document-name "AWS-RunShellScript" \
            --parameters commands="[
              'cd /home/ubuntu/app',
              'aws s3 cp s3://${{ env.DEPLOY_BUCKET }}/rails-portfolio.tar.gz .',
              'docker load < rails-portfolio.tar.gz',
              'docker stop rails-app 2>/dev/null || true',
              'docker rm rails-app 2>/dev/null || true',
              'docker run -d --name rails-app --restart unless-stopped -p 3000:3000 -e RAILS_ENV=production -e RAILS_MASTER_KEY=${{ secrets.RAILS_MASTER_KEY }} rails-portfolio:latest',
              'sleep 5',
              'curl -f http://localhost:3000/up || exit 1',
              'rm -f rails-portfolio.tar.gz',
              'docker image prune -f'
            ]" \
            --output text \
            --query "Command.CommandId")
          
          echo "Command ID: $COMMAND_ID"
          
          # ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œå®Œäº†ã‚’å¾…æ©Ÿ
          aws ssm wait command-executed \
            --command-id $COMMAND_ID \
            --instance-id ${{ needs.terraform.outputs.ec2_instance_id }}
          
          # å®Ÿè¡Œçµæœã®ç¢ºèª
          STATUS=$(aws ssm get-command-invocation \
            --command-id $COMMAND_ID \
            --instance-id ${{ needs.terraform.outputs.ec2_instance_id }} \
            --query "Status" \
            --output text)
          
          if [ "$STATUS" != "Success" ]; then
            echo "Deployment failed!"
            aws ssm get-command-invocation \
              --command-id $COMMAND_ID \
              --instance-id ${{ needs.terraform.outputs.ec2_instance_id }}
            exit 1
          fi
          
          echo "âœ… Deployment successful!"
      
      # âœ… æ–°è¦è¿½åŠ : S3ä¸€æ™‚ãƒã‚±ãƒƒãƒˆã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
      - name: Cleanup S3 Bucket
        if: always()
        run: |
          if [ ! -z "${{ env.DEPLOY_BUCKET }}" ]; then
            aws s3 rm s3://${{ env.DEPLOY_BUCKET }}/rails-portfolio.tar.gz
            aws s3 rb s3://${{ env.DEPLOY_BUCKET }}
          fi
      
      # âœ… å¤‰æ›´: HTTPSã§ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ï¼ˆHTTPãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ä»˜ãï¼‰
      # æ—§ã‚³ãƒ¼ãƒ‰:
      # curl -f http://${{ needs.terraform.outputs.ec2_public_ip }}/up
      
      - name: Verify Deployment
        run: |
          sleep 10
          curl -f -k https://${{ needs.terraform.outputs.ec2_public_ip }}/up || \
          curl -f http://${{ needs.terraform.outputs.ec2_public_ip }}/up
          echo "âœ… Application is running!"
          echo "ğŸŒ Application URL: https://${{ needs.terraform.outputs.ec2_public_ip }}"
      
      - name: Cleanup
        if: always()
        run: |
          rm -f rails-portfolio.tar.gz

  # é€šçŸ¥ (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)
  notify:
    name: Deployment Notification
    runs-on: ubuntu-latest
    needs: [terraform, deploy]
    if: always()
    
    steps:
      - name: Send notification
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "âœ… Deployment succeeded"
            echo "ğŸŒ URL: https://${{ needs.terraform.outputs.ec2_public_ip }}"
            # Slackãªã©ã¸ã®é€šçŸ¥ã‚’è¿½åŠ å¯èƒ½
          else
            echo "âŒ Deployment failed"
          fi
